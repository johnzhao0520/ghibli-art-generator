<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ghibli-Inspired AI Image Generator (MVP)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Ubuntu','Cantarell','Noto Sans','Helvetica Neue','Arial','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol'] }
        }
      }
    }
  </script>
  <style>
    /* 轻微的背景纹理 */
    .subtle-texture {
      background-image: radial-gradient(rgba(16,185,129,0.06) 1px, transparent 1px);
      background-size: 12px 12px;
    }
  </style>
</head>
<body class="min-h-full font-sans bg-gradient-to-b from-emerald-50 to-white text-slate-800">
  <div id="root"></div>

  <!-- React 18 + Babel (仅本地预览用) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // 简易路由（Hash）
    const routes = {
      home: '#/',
      login: '#/login',
      checkout: '#/checkout',
      dashboard: '#/dashboard',
      error: '#/error',
    };

    function useHashRoute() {
      const [hash, setHash] = useState(window.location.hash || routes.home);
      useEffect(() => {
        const onHashChange = () => setHash(window.location.hash || routes.home);
        window.addEventListener('hashchange', onHashChange);
        return () => window.removeEventListener('hashchange', onHashChange);
      }, []);
      return [hash, (h) => { window.location.hash = h; }];
    }

    // 本地状态存储（模拟登录/订阅/试用）
    const storage = {
      getTrial: () => localStorage.getItem('trial_used') === 'true',
      setTrial: (val) => localStorage.setItem('trial_used', val ? 'true' : 'false'),
      getUser: () => {
        try { return JSON.parse(localStorage.getItem('demo_user') || 'null'); }
        catch { return null; }
      },
      setUser: (u) => localStorage.setItem('demo_user', JSON.stringify(u)),
      clearUser: () => localStorage.removeItem('demo_user'),
      getSubActive: () => localStorage.getItem('subscription_active') === 'true',
      setSubActive: (val) => localStorage.setItem('subscription_active', val ? 'true' : 'false'),
    };

    // 按钮通用样式
    function PrimaryButton({ children, onClick, className='', disabled=false, color='emerald' }) {
      const colorMap = {
        emerald: 'bg-emerald-500 hover:bg-emerald-600 focus-visible:ring-emerald-400',
        blue: 'bg-blue-600 hover:bg-blue-700 focus-visible:ring-blue-400',
        slate: 'bg-slate-700 hover:bg-slate-800 focus-visible:ring-slate-400',
      };
      return (
        <button
          onClick={onClick}
          disabled={disabled}
          className={`w-full max-w-xs text-white rounded-md px-5 py-3 font-medium transition-colors shadow
            focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed
            ${colorMap[color] || colorMap.emerald} ${className}`}
        >
          {children}
        </button>
      );
    }

    function OutlineButton({ children, onClick, className='' }) {
      return (
        <button
          onClick={onClick}
          className={`w-full max-w-xs rounded-md px-5 py-3 font-medium border border-emerald-200 text-emerald-700
          hover:bg-emerald-50 transition-colors ${className}`}
        >
          {children}
        </button>
      );
    }

    // 顶部导航
    function NavBar({ user, subscriptionActive }) {
      return (
        <header className="sticky top-0 z-10 bg-white/70 backdrop-blur border-b border-emerald-100">
          <div className="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href={routes.home} className="flex items-center gap-2 group">
              <div className="h-8 w-8 rounded bg-emerald-500 shadow ring-2 ring-emerald-200"></div>
              <span className="text-slate-900 font-semibold tracking-wide group-hover:text-emerald-700 transition-colors">
                Ghibli-Inspired Art
              </span>
            </a>
            <nav className="flex items-center gap-2">
              <a href={routes.dashboard} className="text-sm px-3 py-2 rounded hover:bg-emerald-50 text-slate-700">
                Dashboard
              </a>
              {user ? (
                <span className="text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-800">
                  {subscriptionActive ? 'Subscribed' : 'Free'}
                </span>
              ) : (
                <a href={routes.login} className="text-sm px-3 py-2 rounded bg-emerald-500 text-white hover:bg-emerald-600">
                  Login
                </a>
              )}
            </nav>
          </div>
        </header>
      );
    }

    // 上传组件（拖拽 + 点击）
    function UploadZone({ file, onFileChange }) {
      const [dragOver, setDragOver] = useState(false);
      const inputRef = useRef(null);

      const onDrop = (e) => {
        e.preventDefault();
        setDragOver(false);
        const f = e.dataTransfer.files?.[0];
        if (f) handleFile(f);
      };
      const onDragOver = (e) => { e.preventDefault(); setDragOver(true); };
      const onDragLeave = () => setDragOver(false);
      const handleFile = (f) => {
        const okType = ['image/jpeg', 'image/png'].includes(f.type);
        const okSize = f.size <= 10 * 1024 * 1024; // 10MB
        if (!okType) { alert('请上传 JPG/PNG 图片'); return; }
        if (!okSize) { alert('图片大小需 ≤ 10MB'); return; }
        onFileChange(f);
      };

      return (
        <div
          className={`mt-6 w-full max-w-[600px] mx-auto p-5 rounded-lg border-2 border-dashed
          ${dragOver ? 'border-emerald-500 bg-emerald-50/60' : 'border-emerald-200 bg-white'}
          shadow transition-colors`}
          onDrop={onDrop}
          onDragOver={onDragOver}
          onDragLeave={onDragLeave}
        >
          <div className="text-center space-y-3">
            <div className="text-slate-600">
              拖拽图片到此处，或
              <button
                className="ml-1 text-emerald-700 underline decoration-emerald-300 hover:text-emerald-800"
                onClick={() => inputRef.current?.click()}
              >
                点击上传
              </button>
            </div>
            <div className="text-xs text-slate-500">支持 JPG/PNG，最大 10MB</div>
            <input
              ref={inputRef}
              type="file"
              accept="image/jpeg,image/png"
              className="hidden"
              onChange={(e) => {
                const f = e.target.files?.[0];
                if (f) handleFile(f);
              }}
            />
            {file && (
              <div className="mt-4">
                <img
                  src={URL.createObjectURL(file)}
                  alt="preview"
                  className="mx-auto rounded shadow max-h-64 object-contain"
                />
              </div>
            )}
          </div>
        </div>
      );
    }

    // 首页（Hero）
    function HomePage({ user, subscriptionActive, onSimGenerate, onRequireLogin, trialUsed, style, setStyle, file, setFile, isGenerating, generatedUrl, statusHint }) {
      const canGenerate = user ? subscriptionActive : !trialUsed;
      return (
        <main className="max-w-3xl mx-auto px-4 py-10">
          <section className="text-center subtle-texture rounded-xl p-8">
            <h1 className="text-3xl sm:text-4xl md:text-5xl font-extrabold text-slate-900">
              将你的照片变为 Ghibli 风格插画
            </h1>
            <p className="mt-3 text-slate-600 max-w-[600px] mx-auto">
              一次免费体验。订阅后解锁更多生成次数。Ghibli-inspired，柔和、手绘、幻想的光影与细腻纹理。
            </p>

            <div className="mt-6 w-full max-w-[600px] mx-auto">
              <label className="block text-left text-sm text-slate-700 mb-2">风格（预留）：</label>
              <select
                value={style}
                onChange={(e) => setStyle(e.target.value)}
                className="w-full rounded-md border border-emerald-200 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400"
              >
                <option value="ghibli">Ghibli Inspired</option>
                <option value="ghibli-soft">Ghibli Soft Pastel</option>
                <option value="ghibli-filmic">Ghibli Filmic</option>
              </select>
            </div>

            <UploadZone file={file} onFileChange={setFile} />

            <div className="mt-6 flex flex-col items-center gap-3">
              <PrimaryButton
                onClick={() => {
                  if (!canGenerate) {
                    onRequireLogin();
                    return;
                  }
                  onSimGenerate();
                }}
                disabled={!file || isGenerating}
                color={canGenerate ? 'emerald' : 'blue'}
              >
                {isGenerating ? '正在生成...' : (canGenerate ? '生成图像' : '登录/订阅以继续')}
              </PrimaryButton>
              <div className="text-sm text-slate-600">
                {statusHint}
              </div>
            </div>

            {generatedUrl && (
              <div className="mt-8">
                <div className="text-left text-sm text-slate-700 mb-2">生成结果预览：</div>
                <img src={generatedUrl} alt="generated" className="mx-auto rounded shadow max-h-96 object-contain" />
                <div className="mt-4 flex justify-center">
                  <a
                    href={generatedUrl}
                    download="ghibli-art.png"
                    className="w-full max-w-xs text-center rounded-md px-5 py-3 font-medium bg-emerald-500 text-white hover:bg-emerald-600 transition-colors"
                  >
                    下载图像
                  </a>
                </div>
              </div>
            )}
          </section>
        </main>
      );
    }

    // 登录页（Google OAuth 预留）
    function LoginPage({ onLoginSuccess }) {
      return (
        <main className="max-w-3xl mx-auto px-4 py-16 text-center">
          <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-900">登录以继续</h2>
          <p className="mt-3 text-slate-600 max-w-[600px] mx-auto">使用 Google 登录，完成后将跳转回首页。</p>
          <div className="mt-8 flex flex-col items-center gap-4">
            <PrimaryButton
              color="blue"
              onClick={() => {
                // 模拟 Google OAuth 成功
                const mockUser = { name: 'Demo User', email: 'demo@example.com', avatar: 'https://i.pravatar.cc/100?img=3' };
                storage.setUser(mockUser);
                onLoginSuccess(mockUser);
                window.location.hash = routes.home;
              }}
            >
              使用 Google 登录
            </PrimaryButton>
            <OutlineButton onClick={() => window.location.hash = routes.home}>返回首页</OutlineButton>
          </div>
        </main>
      );
    }

    // 支付页（Stripe Checkout 预留）
    function CheckoutPage({ onCheckoutSuccess }) {
      return (
        <main className="max-w-3xl mx-auto px-4 py-16 text-center">
          <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-900">订阅以解锁更多生成</h2>
          <p className="mt-3 text-slate-600 max-w-[600px] mx-auto">
            月度订阅，随时取消。支付成功后自动跳转回首页并解锁权限。
          </p>
          <div className="mt-8 flex flex-col items-center gap-4">
            <PrimaryButton
              color="emerald"
              onClick={() => {
                // 模拟 Stripe Checkout 成功回调
                setTimeout(() => {
                  storage.setSubActive(true);
                  onCheckoutSuccess();
                  window.location.hash = routes.home;
                  alert('支付成功，已解锁订阅！');
                }, 800);
              }}
            >
              前往 Stripe Checkout
            </PrimaryButton>
            <OutlineButton onClick={() => window.location.hash = routes.home}>返回首页</OutlineButton>
          </div>
        </main>
      );
    }

    // 仪表盘页
    function DashboardPage({ user, subscriptionActive, onPortal, onLogout }) {
      if (!user) {
        return (
          <main className="max-w-3xl mx-auto px-4 py-16 text-center">
            <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-900">请先登录</h2>
            <div className="mt-8 flex flex-col items-center gap-4">
              <PrimaryButton color="blue" onClick={() => window.location.hash = routes.login}>登录</PrimaryButton>
              <OutlineButton onClick={() => window.location.hash = routes.home}>返回首页</OutlineButton>
            </div>
          </main>
        );
      }
      return (
        <main className="max-w-3xl mx-auto px-4 py-10">
          <section className="rounded-xl bg-white shadow p-6">
            <div className="flex items-center gap-4">
              <img src={user.avatar || 'https://i.pravatar.cc/100?img=5'} alt="avatar" className="h-14 w-14 rounded-full shadow" />
              <div>
                <div className="text-lg font-semibold text-slate-900">{user.name || 'User'}</div>
                <div className="text-sm text-slate-600">{user.email || 'user@example.com'}</div>
              </div>
            </div>
            <div className="mt-6 border-t border-emerald-100 pt-6 grid gap-4">
              <div className="flex items-center justify-between">
                <span className="text-slate-700">支付状态</span>
                <span className={`text-sm px-2 py-1 rounded ${subscriptionActive ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-100 text-slate-700'}`}>
                  {subscriptionActive ? 'Active' : 'Inactive'}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-slate-700">订阅方案</span>
                <span className="text-sm text-slate-600">Monthly（无年订阅）</span>
              </div>
              <div className="flex flex-col sm:flex-row items-center gap-3 mt-2">
                <PrimaryButton onClick={onPortal} className="w-full sm:w-auto">Stripe 订阅管理（Portal）</PrimaryButton>
                <OutlineButton onClick={onLogout} className="w-full sm:w-auto">退出登录</OutlineButton>
              </div>
            </div>
          </section>
        </main>
      );
    }

    // 错误页
    function ErrorPage() {
      return (
        <main className="max-w-3xl mx-auto px-4 py-16 text-center">
          <h2 className="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-900">出了点问题</h2>
          <p className="mt-3 text-slate-600 max-w-[600px] mx-auto">请稍后重试，或返回首页。</p>
          <div className="mt-8">
            <PrimaryButton onClick={() => window.location.hash = routes.home}>返回首页</PrimaryButton>
          </div>
        </main>
      );
    }

    function App() {
      const [hash, go] = useHashRoute();

      // 初始化模拟用户数据
      const [user, setUser] = useState(storage.getUser());
      const [subscriptionActive, setSubscriptionActive] = useState(storage.getSubActive());
      const [trialUsed, setTrialUsed] = useState(storage.getTrial());

      // 首页状态
      const [style, setStyle] = useState('ghibli');
      const [file, setFile] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [generatedUrl, setGeneratedUrl] = useState('');

      const statusHint = useMemo(() => {
        if (user) {
          return subscriptionActive ? '订阅已激活：可继续生成' : '已登录：完成订阅后可继续生成';
        }
        return trialUsed ? '已用完免费机会：登录/订阅以继续' : '你还有一次免费机会';
      }, [user, subscriptionActive, trialUsed]);

      const requireLoginOrCheckout = () => {
        if (!user) go(routes.login);
        else go(routes.checkout);
      };

      const simulateGenerate = () => {
        setIsGenerating(true);
        // 模拟生成：用上传图像 + 柔和滤镜（仅预览目的）
        setTimeout(() => {
          if (!file) {
            setIsGenerating(false);
            go(routes.error);
            return;
          }
          const url = URL.createObjectURL(file);
          setGeneratedUrl(url);
          setIsGenerating(false);
          // 写入试用标记（未登录用户）
          if (!user && !trialUsed) {
            storage.setTrial(true);
            setTrialUsed(true);
          }
        }, 1000);
      };

      const handlePortal = () => {
        alert('将跳转至 Stripe Customer Portal（演示环境此处为占位）');
      };

      const handleLogout = () => {
        storage.clearUser();
        storage.setSubActive(false);
        setUser(null);
        setSubscriptionActive(false);
        go(routes.home);
      };

      const onLoginSuccess = (u) => {
        setUser(u);
      };
      const onCheckoutSuccess = () => {
        setSubscriptionActive(true);
      };

      return (
        <div className="min-h-screen">
          <NavBar user={user} subscriptionActive={subscriptionActive} />
          {hash === routes.home && (
            <HomePage
              user={user}
              subscriptionActive={subscriptionActive}
              onSimGenerate={simulateGenerate}
              onRequireLogin={requireLoginOrCheckout}
              trialUsed={trialUsed}
              style={style}
              setStyle={setStyle}
              file={file}
              setFile={setFile}
              isGenerating={isGenerating}
              generatedUrl={generatedUrl}
              statusHint={statusHint}
            />
          )}
          {hash === routes.login && <LoginPage onLoginSuccess={onLoginSuccess} />}
          {hash === routes.checkout && <CheckoutPage onCheckoutSuccess={onCheckoutSuccess} />}
          {hash === routes.dashboard && (
            <DashboardPage
              user={user}
              subscriptionActive={subscriptionActive}
              onPortal={handlePortal}
              onLogout={handleLogout}
            />
          )}
          {hash === routes.error && <ErrorPage />}

          <footer className="mt-10 py-10 text-center text-xs text-slate-500">
            <div className="max-w-3xl mx-auto px-4">
              <div>© 2025 Ghibli-Inspired Art · Privacy · Terms</div>
            </div>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>